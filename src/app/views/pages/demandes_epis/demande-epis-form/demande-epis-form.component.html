<ng-container [formGroup]="demandeEpisForm">
	<tf-portlet-body>
		<div class="tf-heading tf-heading--lg" style="margin-top: 0;">
			<div *ngIf="edit">
				{{'MENU.SUB_DEMANDES_EPI.EDIT' | translate}}
			</div>
			<span *ngIf="!edit">{{'MENU.SUB_DEMANDES_EPI.ADD' | translate}}</span>
		</div>
		<div>
			<div class="tf-wizard-v4__content" data-tfwizard-type="step-content" data-tfwizard-state="current">
				<div class="tf-form__section tf-form__section--first">
					<div class="tf-wizard-v4__form">

						<div class="row">
							<div class="col-12">
								<div class="card card-custom p-4 mb-4">
									<h3>Livraison : </h3>

									<div class="row mt-4">
										<div class="col-3">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_TYPE.TITLE' | translate}}</mat-label>
										</div>
										<div class="col-9">
											<mat-radio-group formControlName="delivery_type">
												<mat-radio-button [value]="1">{{'DEMANDES_EPI.DELIVERY_TYPE.ENTREPRISE.TITLE' | translate}}</mat-radio-button>
												<mat-radio-button [value]="2">{{'DEMANDES_EPI.DELIVERY_TYPE.DOMICILE.TITLE' | translate}}</mat-radio-button>
												<mat-radio-button [value]="3">{{'DEMANDES_EPI.DELIVERY_TYPE.AGENCE.TITLE' | translate}}</mat-radio-button>
											</mat-radio-group>
										</div>
									</div>

									<div class="row mt-4"  *ngIf="demandeEpisForm.get('delivery_type').value && [1,2].includes(demandeEpisForm.get('delivery_type').value)">

										<mat-form-field class="col-3" *ngIf="demandeEpisForm.get('delivery_type').value == 1">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_SOCIETE_NOM.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_societe_nom" formControlName="delivery_societe_nom" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_societe_nom')" />
											<mat-error *ngIf="isControlHasError('delivery_societe_nom','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3" *ngIf="demandeEpisForm.get('delivery_type').value == 1">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_ATTENTION.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_attention" formControlName="delivery_attention" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_attention')" />
											<mat-error *ngIf="isControlHasError('delivery_attention','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3" *ngIf="demandeEpisForm.get('delivery_type').value == 2">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_NOM.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_nom" formControlName="delivery_nom" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_nom')" />
											<mat-error *ngIf="isControlHasError('delivery_nom','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3" *ngIf="demandeEpisForm.get('delivery_type').value == 2">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_PRENOM.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_prenom" formControlName="delivery_prenom" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_prenom')" />
											<mat-error *ngIf="isControlHasError('delivery_prenom','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>

									</div>
									<div class="row mt-4" *ngIf="demandeEpisForm.get('delivery_type').value && [1,2].includes(demandeEpisForm.get('delivery_type').value)">	
										<mat-form-field class="col-3"  >
											<mat-label>{{'DEMANDES_EPI.DELIVERY_NUMERO.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_numero" formControlName="delivery_numero" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_numero')" />
											<mat-error *ngIf="isControlHasError('delivery_numero','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_RUE.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_rue" formControlName="delivery_rue" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_rue')" />
											<mat-error *ngIf="isControlHasError('delivery_rue','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_CP.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_cp" formControlName="delivery_cp" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_cp')" />
											<mat-error *ngIf="isControlHasError('delivery_cp','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3" *ngIf="demandeEpisForm.get('delivery_type').value && [1,2].includes(demandeEpisForm.get('delivery_type').value)">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_VILLE.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_ville" formControlName="delivery_ville" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_ville')" />
											<mat-error *ngIf="isControlHasError('delivery_ville','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
	
										<mat-form-field class="col-3">
											<mat-label>{{'DEMANDES_EPI.DELIVERY_PAYS.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="delivery_pays" formControlName="delivery_pays" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('delivery_pays')" />
											<mat-error *ngIf="isControlHasError('delivery_pays','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
									</div>
									
									<div class="row mt-4" *ngIf="demandeEpisForm.get('delivery_type').value && demandeEpisForm.get('delivery_type').value == 3">

										<mat-form-field class="col-3">
											<mat-label>{{'DEMANDES_EPI.BU.TITLE' | translate}}</mat-label>
											<mat-select  class="form-control" placeholder="{{'ACTION.ENTER_HERE' | translate}}" formControlName="bu_id">
												<mat-option *ngFor="let bu of busList" [value]="bu.id">{{bu.libelle}}</mat-option>
											</mat-select>
											<mat-error *ngIf="isControlHasError('bu_id','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>
										
										<mat-form-field class="col-3" *ngIf="demandeEpisForm.get('bu_id').value && getBuCode() == 'Autres'">
											<mat-label>{{'DEMANDES_EPI.BU_AUTRE.TITLE' | translate}}</mat-label>
											<input class="form-control" matInput name="bu_autre" formControlName="bu_autre" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('bu_autre')" />
											<mat-error *ngIf="isControlHasError('bu_autre','required')">
												<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
											</mat-error>
										</mat-form-field>

									</div>
								</div>
							</div>
						</div>
						<ng-container formArrayName="epis">
							<div class="row mt-4" *ngFor="let epi of epis.controls; index as i">
								<div class="col-12">
									<div class="card card-custom p-4 mb-4"  >
										<ng-container [formGroupName]="i">
											<div class="row form-row">
												<div class="col-11">
													<tf-tree-select [itemsList]="categoriesList" [fromId]="epi.get('categorie_id').value" [required]="true" [withAll]="false" [translateTitle]="'MATERIELS.CATEGORIE'" [itemsToHandle]="itemsToHandle" (onChangedItem)="categorieChanged($event, i)" (onSelectedItemsToHandle)="itemsToHandleSelected($event, i)" *ngIf="categoriesList" [fromSource]="true"></tf-tree-select>
												</div>
												<div class="col-1 text-right">
													<button mat-icon-button color="warn" type="button" (click)="removeEpi(i)">
														<mat-icon>delete</mat-icon>
													</button>
												</div>
											</div>
											<div class="row form-row">
												<mat-form-field class="col-3">
													<mat-label>{{'DEMANDES_EPI.QTE' | translate}}</mat-label>
													<input class="form-control" matInput type="number" min="1" name="qte" formControlName="qte" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('qte')" />
													<mat-error *ngIf="isControlHasError('qte','required')">
														<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
													</mat-error>
													<mat-error *ngIf="isControlHasError('qte','min')">
														<strong>{{ 'AUTH.VALIDATION.MINIMAL_QUANTITY' | translate }}</strong>
													</mat-error>
												</mat-form-field>
												<mat-form-field class="col-xl-3" *ngIf="epi?.get('displayExtraFields')?.value">
													<mat-label>{{'MATERIELS.SIZE.LABEL' | translate}}</mat-label>
													<input class="form-control" matInput type="number" name="size" formControlName="size" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('size')" />
													<mat-error *ngIf="isControlHasError('size','required')">
														<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
													</mat-error>
												</mat-form-field>
		
												<mat-form-field class="col-xl-3" *ngIf="epi?.get('displayExtraFields')?.value">
													<mat-label>{{'MATERIELS.CRITERIA.LABEL' | translate}}</mat-label>
													<mat-select class="form-control" formControlName="criteria_id" name="criteria_id" placeholder="{{'ACTION.ENTER_HERE' | translate}}">
														<mat-option *ngFor="let item of criteriasList" [value]="item.id">
															{{item.libelle}}
														</mat-option>
													</mat-select>
													<button type="button" mat-button matSuffix mat-icon-button aria-label="Clear" (click)="clearValue('criteria_id'); $event.stopPropagation()">
														<mat-icon>clear</mat-icon>
													</button>
													<mat-error *ngIf="isControlHasError('criteria_id','required')">
														<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
													</mat-error>
												</mat-form-field>
		
												<mat-form-field class="col-xl-3" *ngIf="epi?.get('displaySubcategory')?.value">
													<mat-label>{{'MATERIELS.SUB_CATEGORY.LABEL' | translate}}</mat-label>
													<mat-select class="form-control" formControlName="subcategory_id" name="subcategory_id" placeholder="{{'ACTION.ENTER_HERE' | translate}}">
														<mat-option *ngFor="let item of subcategoriesList" [value]="item.id">
															{{item.libelle}}
														</mat-option>
													</mat-select>
													<button type="button" mat-button matSuffix mat-icon-button aria-label="Clear" (click)="clearValue('subcategory_id'); $event.stopPropagation()">
														<mat-icon>clear</mat-icon>
													</button>
													<mat-error *ngIf="isControlHasError('subcategory_id','required')">
														<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
													</mat-error>
												</mat-form-field>
												<mat-form-field class="col-12">
													<mat-label>{{'DEMANDES_EPI.COMMENT' | translate}}</mat-label>
													<textarea class="form-control" matInput rows="3" type="text" name="comment" formControlName="comment" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [required]="isFieldRequired('comment')" ></textarea>
													<mat-error *ngIf="isControlHasError('comment','required')">
														<strong>{{ 'AUTH.VALIDATION.REQUIRED_FIELD' | translate }}</strong>
													</mat-error>
												</mat-form-field>
											</div>
										</ng-container>
									</div>
								</div>
							</div>
						</ng-container>	
						<div class="row">
							<div class="col-12 mt-4">
								<button type="button" class="p-2 w-100" mat-raised-button color="success" (click)="addEpi()"><mat-icon class="mr-2">add</mat-icon>Ajouter un EPI</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</tf-portlet-body>
</ng-container>
