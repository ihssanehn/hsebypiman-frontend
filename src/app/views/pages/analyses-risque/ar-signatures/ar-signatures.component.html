<mat-expansion-panel [expanded]="true">
	<mat-expansion-panel-header>
		<div class="tf-heading tf-heading--md">| 5 {{'ARS.FORM.SIGNATURE_OBSERVATION.TITLE' | translate}}</div>
	</mat-expansion-panel-header>

	<form [formGroup]="signaturesForm" class="tf-form tf-form--group-seperator-dashed">

		<div class="row">
			<div class="col-md-12">
				<div class="tf-card-form">
					<div class="tf-heading tf-heading--sm">
						{{'ARS.FORM.SIGNATURE.SUBTITLE' | translate}}
					</div>

					<div class="row form-row">
						<div class="col-md-12 textarea-viewer">
							<p class="mt-2">{{observation}}</p>
						</div>
					</div>

					<!-- Ajouter des signatures -->
					<ng-container >
						<div class="tf-heading tf-heading--sm">
							{{'ARS.FORM.SIGNATURE.DECLARATION' | translate}}
						</div>

						<div>
							<div>
								<p class="font-weight-bold text-right add-signature-line-btn"><a (click)="addSignatures()">+ Ajouter un signataire</a></p>
							</div>
							<div class="row form-row signature-line" *ngFor="let signature of signaturesForm.controls; let i=index" [formGroupName]="i" >

								<div class="col-xl-1 ">
									<mat-label>{{'COMMON.DATE.LABEL' | translate}} </mat-label>
									<p class="mt-2"><strong>{{signaturesForm.controls[i].value.date| date:'dd/MM/yyyy'}}</strong></p>
								</div>

								<div class="col-xl-2 " *ngIf="signaturesForm.controls[i].value.personnel">
									<mat-label>{{'COMMON.LASTNAME.LABEL' | translate}}&nbsp;{{'COMMON.FIRSTNAME.LABEL' | translate}} </mat-label>
									<p class="mt-2"><strong>{{signaturesForm.controls[i].value.personnel?.fullname}}</strong></p>
								</div>

								<mat-form-field class="col-xl-2 " *ngIf="!signaturesForm.controls[i].value.personnel">
									<mat-label>{{'COMMON.LASTNAME.LABEL' | translate}}&nbsp;{{'COMMON.FIRSTNAME.LABEL' | translate}} </mat-label>
									<input class="form-control" matInput type="text" name="signataire_fullname" formControlName="signataire_fullname" placeholder="Saisir ici" />
								</mat-form-field>

								<mat-form-field class="col-xl-2 ">
									<mat-label>{{'COMMON.SOCIETE.LABEL' | translate}} </mat-label>
									<mat-select class="form-control" formControlName="entreprise_id" name="entreprise_id">
										<mat-option *ngFor="let entreprise of entreprisesList" [value]="entreprise.id">
											{{entreprise.raison_sociale}}
										</mat-option>
									</mat-select>
								</mat-form-field>

								<mat-form-field class="col-xl-2 ">
									<mat-label>{{'COMMON.REMARQUE.LABEL' | translate}} </mat-label>
									<input class="form-control" matInput type="text" name="commentaires" formControlName="commentaires" placeholder="Saisir ici" />
								</mat-form-field>

								<div class="col-xl-4 form-row-flex">
									<label>{{'COMMON.SIGNATURE.LABEL' | translate}} </label>
									<button *ngIf="signaturesForm.controls[i].value.personnel" mat-icon-button color="accent" matTooltip="{{'ACTION.CLEAR' | translate}}" (click)="clearSignature(i)">
										<mat-icon>delete</mat-icon>
									</button>
									<div class="signature-container">
										<signature-pad id="sign_canvas" (window:resize)="resizeSignaturePad()" [options]="signaturePadOptions" (onBeginEvent)="drawStart()" (onEndEvent)="drawComplete(i)"></signature-pad>
									</div>
								</div>

								<div class="col-xl-1" *ngIf="!signaturesForm.controls[i].value.personnel">
									<div class="sign-line-options">
										<div ngbDropdown placement="bottom-right" class="d-inline-block">
											<button ngbDropdownToggle mat-icon-button color="secondary" matTooltip="Actions">
												<mat-icon>more_vert</mat-icon>
											</button>
											<div ngbDropdownMenu class="dropdown-menu dropdown-menu-anim dropdown-menu-top-unround " style="min-width: max-content; padding: 5px;">
												<button mat-icon-button color="accent" matTooltip="{{'ACTION.DELETE' | translate}}" (click)="removeSignature(i)">
													<mat-icon>delete</mat-icon>
												</button>
											</div>
										</div>
									</div>
								</div>
								
							</div>
						</div>

					</ng-container>

					<!-- Liste signatures -->
					<ng-container *ngIf="signatures.length">
						<div class="tf-heading tf-heading--sm mt-4">
							{{'ARS.FORM.SIGNATURE_OBSERVATION.SHORTTITLE' | translate}}
						</div>

						<table mat-table [dataSource]="signatures">
		
							<ng-container matColumnDef="date">
								<th mat-header-cell *matHeaderCellDef> {{'COMMON.DATE.LABEL' | translate}} </th>
								<td mat-cell *matCellDef="let element"> {{element.date| date:'dd/MM/yyyy'}} </td>
							</ng-container>
		
							<ng-container matColumnDef="fullname">
								<th mat-header-cell *matHeaderCellDef> {{'COMMON.LASTNAME.LABEL' | translate}}&nbsp;{{'COMMON.FIRSTNAME.LABEL' | translate}} </th>
								<td mat-cell *matCellDef="let element">
									<strong *ngIf="element.salarie"> {{element.salarie?.fullname}} </strong>
									<strong *ngIf="!element.salarie"> {{element.signataire_fullname}} </strong>
								</td>
							</ng-container>

							<ng-container matColumnDef="entreprise">
								<th mat-header-cell *matHeaderCellDef> {{'COMMON.SOCIETE.LABEL' | translate}} </th>
								<td mat-cell *matCellDef="let element"> {{element.entreprise?.raison_sociale}} </td>
							</ng-container>
		
							<ng-container matColumnDef="comments">
								<th mat-header-cell *matHeaderCellDef> {{'COMMON.REMARQUE.LABEL' | translate}} </th>
								<td mat-cell *matCellDef="let element"> {{element.commentaires}} </td>
							</ng-container>

							<ng-container matColumnDef="signature">
								<th mat-header-cell *matHeaderCellDef> {{'COMMON.SIGNATURE.LABEL' | translate}} </th>
								<td mat-cell *matCellDef="let element">
									<div class="signature-viewer">
										<img [src]="_sanitizer.bypassSecurityTrustResourceUrl(element.signature)" width="100%">
									</div>
								</td>
							</ng-container>
		
							<tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
							<tr mat-row *matRowDef="let row; columns: displayedColumns;" ></tr>
						</table>

					</ng-container>

				</div>
			</div>
		</div>

		<button mat-raised-button [disabled]="signaturesForm.invalid" class="btn float-right btn-save" (click)="signaturesForm.valid && onSubmit(false)">
			{{'ACTION.SAVE' | translate}}
		</button>

	</form>

</mat-expansion-panel>
