<form [formGroup]="actionForm">
<tf-portlet class="tf-portlet--height-fluid mat-elevation-z8" id="portlet-action" *ngIf="action">
  <div class="tf-portlet-header ">
    <span class="title">
      <a [routerLink]="['/plan-actions/list']">{{'MENU.SUB_PLANACTION.LIST' | translate}}</a><span class="divider">></span><span class="id-item">Action {{action.created_at | date:'dd/MM/yyyy'}}</span>
    </span>
    <div ngbDropdown placement="bottom-right" class="d-inline-block pull-right" *ngIf="action.status.code != 'ABANDONNE' && action.status.code != 'TERMINE'">
      <button ngbDropdownToggle mat-icon-button color="primary" matTooltip="Actions" style="line-height: 0;height: 0;">
        <mat-icon>more_vert</mat-icon>
      </button>
      <div ngbDropdownMenu class="dropdown-menu dropdown-menu-anim dropdown-menu-top-unround " style="min-width: max-content; padding: 5px;">
        <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="editAction(action.id)" *ngxPermissionsOnly="['action_canUpdate']">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="warn" matTooltip="{{'ACTION.DELETE' | translate}}" (click)="deleteAction(action.id)" *ngxPermissionsOnly="['action_canArchieve']">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
    <div class="status-box mx-4 px-2 d-inline-block pull-right" [ngStyle]="action.status && action.status.color && {'color':action.status.color}">
      <mat-icon svgIcon="status-encours" class="status-icon mr-2" *ngIf="action.status?.code == 'EN_COURS'"></mat-icon>
      <mat-icon svgIcon="status-termine" class="status-icon mr-2" *ngIf="action.status?.code == 'TERMINE'"></mat-icon>
      <mat-icon inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;position: relative;top: 3px;" *ngIf="action.status?.code == 'A_ATTRIBUER'">person_add</mat-icon>
      <mat-icon inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;position: relative;top: 3px;" *ngIf="action.status?.code == 'ABANDONNE'">stop</mat-icon>
      {{action.status?.libelle}}
    </div>
  </div>

  <tf-portlet-body class="tf-portlet__body--fit">
    <div class="row">

      <div class="col-6 d-flex">
        <div class="row d-flex flex-column flex-nowrap flex-fill">

          <div class="col-12 flex-fill">
            <div class="card">
              <ng-container *ngxPermissionsOnly="['ADMIN','ROOT']">
                <span class="card-editor" *ngIf="action?.status?.code != 'ABANDONNE'">
                  <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="setOrigineMode(true)" *ngIf="!origineMode; else validationOrigine">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <ng-template #validationOrigine>
                    <button mat-icon-button color="info" matTooltip="{{'ACTION.SAVE' | translate}}" (click)="save('origine')">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" matTooltip="{{'ACTION.CANCEL' | translate}}" (click)="setOrigineMode(false)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </ng-template>
                </span>
              </ng-container>
              <h5><b>{{'PLANACTIONS.CARD.ORIGIN.TITLE' | translate}}</b></h5>
              <ng-container *ngIf="!origineMode; else origineEdit">
                <div class="box box-info" style="flex: 1;">
                  <p style="text-align:right"><span class="label pull-left mr-2">{{'PLANACTIONS.ORIGINE.LABEL' | translate}}</span><span class="">{{action.type?.libelle}}</span></p>
                  <ng-container *ngIf="action.type?.code== 'VISITE_SECURITE'">
                    <div class="row">
                      <div class="col-12 my-2"><p><span class="label">{{'PLANACTIONS.VS_CONCERNED.TITLE' | translate}}</span></p></div>
                      <ng-container *ngIf="action.actionable">
                        <div class="col-12 vs-line" *ngIf="action.actionable.rvs; else visiteAction">
                          <div class="col-5"><p class="blue">{{action.actionable?.rvs?.code}}</p></div>
                          <div class="col-5"><p class="blue">{{action.actionable?.rvs?.date_visite | date:'dd/MM/yyyy'}}</p></div>
                          <div class="col-2" ><p class="blue"><a (click)="goToVsDetail(action.actionable?.rvs?.id)" alt="voir la visite de sécurité"><mat-icon color="primary">visibility</mat-icon></a></p></div>
                        </div>
                        <ng-template #visiteAction>
                          <div class="col-12 vs-line">
                            <div class="col-5"><p class="blue">{{action.actionable?.code}}</p></div>
                            <div class="col-5"><p class="blue">{{action.actionable?.date_visite | date:'dd/MM/yyyy'}}</p></div>
                            <!-- <div class="col-2" ><p class="blue"><a (click)="goToVsDetail(action.actionable?.id)" alt="voir la visite de sécurité"><mat-icon color="primary">visibility</mat-icon></a></p></div> -->
                          </div>
                        </ng-template>
                      </ng-container>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="action.type?.code == 'REMONTE_D_INFORMATION'">
                    <div class="row">
                      <div class="col-12 my-2"><p><span class="label">{{'PLANACTIONS.LIFT_CONCERNED.TITLE' | translate}}</span></p></div>
                      <ng-container *ngIf="action.actionable">
                        <div class="col-12 vs-line" >
                          <div class="col-5"><p class="blue">{{action.actionable?.creator | fullName}}</p></div>
                          <div class="col-5"><p class="blue">{{action.actionable?.created_at | date:'dd/MM/yyyy'}}</p></div>
                          <div class="col-2" ><p class="blue"><a (click)="goToRemonteeDetail(action.actionable?.id)" alt="voir la remontee"><mat-icon color="primary">visibility</mat-icon></a></p></div>
                        </div>
                      </ng-container>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
              <ng-template #origineEdit>
                <template [ngTemplateOutlet]="editOrigine" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
              </ng-template>
            </div>  
          </div>

          <div class="col-12 mt-4 flex-fill">
            <div class="card">
              <ng-container *ngxPermissionsOnly="['ADMIN','ROOT']">
                <span class="card-editor" *ngIf="action?.status?.code != 'ABANDONNE'">
                  <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="setInfosMode(true)"  *ngIf="!infosMode; else validationInfos">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <ng-template #validationInfos>
                    <button mat-icon-button color="info" matTooltip="{{'ACTION.SAVE' | translate}}" (click)="save('infos')">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" matTooltip="{{'ACTION.CANCEL' | translate}}" (click)="setInfosMode(false)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </ng-template>
                </span>
              </ng-container>
              <h5><b>{{'PLANACTIONS.CARD.GENERAL_INFOS.TITLE' | translate}}</b></h5>
              <ng-container *ngIf="!infosMode; else infosEdit">
                <div class="box box-info" style="flex: 1;">
                  <h6><b>{{'PLANACTIONS.NAME.LABEL' | translate}}</b></h6>
                  <div class="row">
                    <div class="col-md-12 my-2"><p><span class="action-label" *ngIf="action.libelle; else noDataFound">{{action.libelle}}</span></p></div>
                  </div>
                </div>
                <div class="box box-info" style="flex: 1;">
                  <h6><b>{{'PLANACTIONS.RISQUE.LABEL' | translate}}</b></h6>
                  <div class="row">
                    <div class="col-md-12 my-2"><p><span class="action-label" *ngIf="action.risque; else noDataFound">{{action.risque}}</span></p></div>
                  </div>
                </div>
                <div class="box box-info" style="flex: 1;">
                  <h6><b>{{'PLANACTIONS.OBJECTIF.LABEL' | translate}}</b></h6>
                  <div class="row">
                    <div class="col-md-12 my-2"><p><span class="action-label" *ngIf="action.objectif; else noDataFound">{{action.objectif}}</span></p></div>
                  </div>
                </div>
              </ng-container>
              <ng-template #infosEdit>
                <template [ngTemplateOutlet]="editName" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                <template [ngTemplateOutlet]="editObjectif" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                <template [ngTemplateOutlet]="editRisque" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
              </ng-template>
              <div class="tf-divider">
                <span></span>
              </div>
              <div class="box text-center">
                <small>{{'COMMON.CREATED_AT.TITLE' | translate}} : {{action.created_at | date:'dd/MM/yyyy'}}</small><br>
                <small>{{'COMMON.UPDATED_AT.TITLE' | translate}} : {{action.updated_at | date:'dd/MM/yyyy'}}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-6 d-flex">
        <div class="row d-flex flex-column flex-nowrap flex-fill">
          
            <div class="col-12 flex-fill">
              <div class="card">
                <span class="card-editor" *ngIf="action?.status?.code != 'ABANDONNE'">
                  <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="setAttribMode(true)" *ngIf="!attribMode; else validationAttrib" >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <ng-template #validationAttrib>
                    <button mat-icon-button color="info" matTooltip="{{'ACTION.SAVE' | translate}}" (click)="save('attribution')">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" matTooltip="{{'ACTION.CANCEL' | translate}}" (click)="setAttribMode(false)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </ng-template>
                </span>
                <h5><b>{{'PLANACTIONS.CARD.ALLOCATION_DEADLINE.TITLE' | translate}}</b></h5>
                <div class="box" style="flex:1">
                  <ng-container *ngIf="!attribMode; else adEdit">
                    <p class="mt-3"><span class="label pull-left mr-2">{{'PLANACTIONS.PILOTE.LABEL' | translate}}</span><span class="" *ngIf="action.pilote; else noDataFound">{{action.pilote | fullName}}</span></p>
                    <p><span class="label pull-left mr-2">{{'PLANACTIONS.DELAI.LABEL' | translate}}</span><span class="" *ngIf="action.delai; else noDataFound">{{action.delai}}</span></p>
                  </ng-container>
                  <ng-template #adEdit>
                    <template [ngTemplateOutlet]="selectPilote" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                    <template [ngTemplateOutlet]="editDelai" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                  </ng-template>
                </div>
              </div>
            </div>

            <div class="col-12 mt-4 flex-fill">
              <div class="card">
                <span class="card-editor" *ngIf="action?.status?.code != 'ABANDONNE'">
                  <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="setResoMode(true)" *ngIf="!resoMode; else validationRes" >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <ng-template #validationRes>
                    <button mat-icon-button color="info" matTooltip="{{'ACTION.SAVE' | translate}}" (click)="save('resolution')">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" matTooltip="{{'ACTION.CANCEL' | translate}}" (click)="setResoMode(false)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </ng-template>
                </span>
                <h5><b>{{'PLANACTIONS.CARD.RESOLUTION.TITLE' | translate}}</b></h5>
                <div class="box" style="flex:1">
                  <ng-container *ngIf="!resoMode; else resEdit">
                    <p><span class="label pull-left mr-2">{{'PLANACTIONS.REALISATION.LABEL' | translate}}</span><span class="" *ngIf="action.date_realisation; else noDataFound">{{action.date_realisation}}</span></p>
                    <p><span class="label pull-left mr-2">{{'PLANACTIONS.COMMENT.LABEL' | translate}}</span><span class="" *ngIf="action.commentaires; else noDataFound">{{action.commentaires}}</span></p>  
                  </ng-container>
                  <ng-template #resEdit>
                    <template [ngTemplateOutlet]="editRealisation" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                    <template [ngTemplateOutlet]="editComment" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                  </ng-template>
                </div>
              </div>
            </div>

            <div class="col-12 mt-4 flex-fill">
              <div class="card">
                <span class="card-editor" *ngIf="action?.status?.code != 'ABANDONNE'">
                  <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="setEfficMode(true)" *ngIf="!efficMode; else validationEffic" >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <ng-template #validationEffic>
                    <button mat-icon-button color="info" matTooltip="{{'ACTION.SAVE' | translate}}" (click)="save('efficacite')">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" matTooltip="{{'ACTION.CANCEL' | translate}}" (click)="setEfficMode(false)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </ng-template>
                </span>
                <h5><b>{{'PLANACTIONS.CARD.EFFICIENCY.TITLE' | translate}}</b></h5>
                <div class="box" style="flex:1">
                  <ng-container *ngIf="!efficMode; else effEdit">
                    <p><span class="label pull-left mr-2">{{'PLANACTIONS.EFFICACITE.LABEL' | translate}}</span><span class="" *ngIf="action.efficacite; else noDataFound">{{action.efficacite}}</span></p>
                  </ng-container>
                  <ng-template #effEdit>
                    <template [ngTemplateOutlet]="editEff" [ngTemplateOutletContext]="{formGroup: actionForm}"></template>
                  </ng-template> 
                </div>
              </div>
            </div>
          
        </div>
      </div>
    </div>
    <div class="row mt-4" >
      <div class="col-12">
        <ng-container *ngxPermissionsOnly="['action_canUpdate']">
          <button *ngIf="action.status.code == 'A_ATTRIBUER'" class="pull-right"  mat-raised-button color="info" (click)="attributeAction()">
            <mat-icon inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;">person_add</mat-icon>
            {{'PLANACTIONS.ACTION.ASSIGN_ACTION' | translate}}
          </button>
          <button *ngIf="action.status.code == 'EN_COURS'" class="pull-right"  mat-raised-button color="info" (click)="cloreAction()">
            <mat-icon  svgIcon="status-termine" inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;"></mat-icon>
            {{'PLANACTIONS.ACTION.CLOSE_ACTION' | translate}}
          </button>
          <span class="pull-left" *ngIf="action.status.code != 'TERMINE' && action.status.code != 'ABANDONNE'">
            <button mat-raised-button color="warn" (click)="abandonAction(action.id)">
              <mat-icon inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;">stop</mat-icon>
              {{'PLANACTIONS.ACTION.ABANDON_ACTION' | translate}}
            </button>
          </span>
        </ng-container>
      </div>
    </div>
  </tf-portlet-body>

</tf-portlet>

</form>

<ng-template #editOrigine let-formGroup="formGroup">
  <div class="box box-info" style="flex: 1;">
    <mat-form-field class="col-md-4 col-sm-12">
      <mat-label>{{'PLANACTIONS.ORIGINE.LABEL' | translate}}</mat-label>
      <mat-select class="form-control" placeholder="" [formControl]="formGroup.get('type_id')">
        <mat-option *ngFor="let type of typesList" [value]="type.id">
          {{ type.libelle }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="col-md-4 col-sm-12" *ngIf="selectedTypeHasCode() == 'VISITE_SECURITE'">
      <mat-label>{{'VISITES.TYPE.LABEL' | translate}}</mat-label>
      <mat-select class="form-control" [formControl]="formGroup.get('visite_type')">
        <mat-option *ngFor="let visiteType of visiteTypesList" [value]="visiteType">
          {{ visiteType.value | translate }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="col-md-4 col-sm-12" *ngIf="selectedTypeHasCode() == 'VISITE_SECURITE' && visitesList">
      <mat-label>{{'VISITES.CODE.LABEL' | translate}}</mat-label>
      <input class="form-control" matInput type="text" name="actionable" [formControl]="formGroup.get('actionable')" placeholder="{{'ACTION.ENTER_HERE' | translate}}" [matAutocomplete]="auto" />
      <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
        <mat-option *ngFor="let visite of filteredVisites | async" [value]="visite" (click)="initFilteredVisites()" style="height: 2em;line-height: 2em;">
          {{visite.code}}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>
  </div>
</ng-template>

<ng-template #editName let-formGroup="formGroup">
  <div class="box box-info" style="flex: 1;">
    <mat-form-field class="col-xl-12">
      <mat-label>{{'PLANACTIONS.NAME.LABEL' | translate}}</mat-label>
      <textarea class="form-control" matInput name="libelle" [formControl]="formGroup.get('libelle')" [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2"  [cdkAutosizeMaxRows]="20" placeholder="{{'ACTION.ENTER_HERE' | translate}}" rows="2"></textarea>
    </mat-form-field>
  </div>
</ng-template>

<ng-template #editObjectif let-formGroup="formGroup">
  <div class="box box-info" style="flex: 1;">
    <mat-form-field class="col-xl-12">
      <mat-label>{{'PLANACTIONS.OBJECTIF.LABEL' | translate}}</mat-label>
      <textarea class="form-control" matInput name="objectif" [formControl]="formGroup.get('objectif')" [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2"  [cdkAutosizeMaxRows]="20" placeholder="{{'ACTION.ENTER_HERE' | translate}}" rows="2"></textarea>
    </mat-form-field>
  </div>
</ng-template>

<ng-template #editRisque let-formGroup="formGroup">
  <div class="box box-info" style="flex: 1;">
    <mat-form-field class="col-xl-12">
      <mat-label>{{'PLANACTIONS.RISQUE.LABEL' | translate}}</mat-label>
      <textarea class="form-control" matInput name="risque" [formControl]="formGroup.get('risque')" [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2"  [cdkAutosizeMaxRows]="20" placeholder="{{'ACTION.ENTER_HERE' | translate}}" rows="2"></textarea>
    </mat-form-field>
  </div>
</ng-template>


<ng-template #selectPilote let-formGroup="formGroup">
  <mat-form-field class="col-xl-12">
    <mat-label>{{'PLANACTIONS.PILOTE.LABEL' | translate}}</mat-label>
    <mat-select class="form-control" placeholder="" [formControl]="formGroup.get('pilote_id')" >
      <mat-option *ngFor="let user of usersList" [value]="user.id">
        {{ user.fullname }}
      </mat-option>
    </mat-select>
  </mat-form-field>
</ng-template>

<ng-template #editDelai let-formGroup="formGroup">
<mat-form-field class="col-xl-12">
  <mat-label>{{'PLANACTIONS.DELAI.LABEL' | translate}}</mat-label>
  <input matInput mask="d0/M0/0000" [specialCharacters]="[ '/' ]" [dropSpecialCharacters]="false" [formControl]="formGroup.get('delai')" #delai class="form-control" name="delai" placeholder="DD/MM/YYYY" />
</mat-form-field>
</ng-template>

<ng-template #editRealisation let-formGroup="formGroup">
<mat-form-field class="col-xl-12">
  <mat-label>{{'PLANACTIONS.REALISATION.LABEL' | translate}}</mat-label>
  <input matInput mask="d0/M0/0000" [specialCharacters]="[ '/' ]" [dropSpecialCharacters]="false" [formControl]="formGroup.get('date_realisation')" #date_realisation class="form-control" name="date_realisation" placeholder="DD/MM/YYYY" />
</mat-form-field>
</ng-template>

<ng-template #editComment let-formGroup="formGroup">
<mat-form-field class="col-xl-12">
  <mat-label>{{'PLANACTIONS.COMMENT.LABEL' | translate}}</mat-label>
  <textarea class="form-control" matInput name="commentaires" [formControl]="formGroup.get('commentaires')" [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2"  [cdkAutosizeMaxRows]="20" placeholder="{{'ACTION.ENTER_HERE' | translate}}" rows="2"></textarea>
</mat-form-field>
</ng-template>

<ng-template #editEff let-formGroup="formGroup">
<mat-form-field class="col-xl-12">
  <mat-label>{{'PLANACTIONS.EFFICACITE.LABEL' | translate}}</mat-label>
  <input matInput #efficacite class="form-control" [formControl]="formGroup.get('efficacite')" type="string" name="efficacite" placeholder="{{'ACTION.ENTER_HERE' | translate}}" />
</mat-form-field>
</ng-template>


<ng-template #noDataFound>
  <span class="no-data-label">
    {{'COMMON.NO_DATA_FOUND.TITLE' | translate}}
  </span>
</ng-template>
