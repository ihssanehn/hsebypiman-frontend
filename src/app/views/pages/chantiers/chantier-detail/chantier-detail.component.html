<tf-portlet class="tf-portlet--height-fluid mat-elevation-z8" id="portlet-chantier" *ngIf="chantier">
  <div class="tf-portlet-header ">
    <span class="title">
      <a [routerLink]="['/chantiers/list']">{{'MENU.SUB_CHANTIER.LIST' | translate}}</a><span class="divider">></span><span class="id-item">{{chantier.nom}}</span>
    </span>
    <div ngbDropdown placement="bottom-right" class="d-inline-block pull-right">
      <button ngbDropdownToggle mat-icon-button color="primary" matTooltip="Actions" style="line-height: 0;height: 0;">
        <mat-icon>more_vert</mat-icon>
      </button>
      <div ngbDropdownMenu class="dropdown-menu dropdown-menu-anim dropdown-menu-top-unround " style="min-width: max-content; padding: 5px;">
        <button mat-icon-button color="info" matTooltip="{{'ACTION.EDIT' | translate}}" (click)="editChantier(chantier.id)">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="warn" matTooltip="{{'ACTION.DELETE' | translate}}" (click)="deleteChantier(chantier.id)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
    <div class="status-box mx-4 px-2 d-inline-block pull-right" [ngStyle]="chantier.status && chantier.status.color && {'color':chantier.status.color}">
      <mat-icon svgIcon="{{chantier.status?.code == 'ENCOURS' ? 'status-encours':'status-termine'}}" class="status-icon mr-2"></mat-icon>
      {{chantier.status?.libelle}}
    </div>
  </div>
  <tf-portlet-body class="tf-portlet__body--fit">
    <div class="row">
      <div class="col-md-4">
        <div class="card">
          <h3>Informations générales</h3>
          <div class="box" style="flex:1">
            <p><span class="label pull-left mr-2">{{'CHANTIERS.NAME.SHORTTITLE' | translate}}</span><span class="">{{chantier.nom}}</span></p>
            <p><span class="label pull-left mr-2">{{'CHANTIERS.TYPE.SHORTTITLE' | translate}}</span><span class="">{{chantier.type?.libelle}}</span></p>
            <p><span class="label pull-left mr-2">{{'CHANTIERS.DATE_DEMARRAGE.TITLE' | translate}}</span><span class="">{{chantier.date_demarrage | date:'dd/MM/yyyy'}}</span></p>
            <p><span class="label pull-left mr-2">{{'CHANTIERS.CHIEF.TITLE' | translate}}</span><span class="">{{chantier.charge_affaire | fullName}}</span></p>
            <p><span class="label pull-left mr-2">{{'CHANTIERS.BUDGET.SHORTTITLE' | translate}}</span><span class="">{{chantier.montant | currency:'EUR':'€'}}</span></p>
          </div>
          <div class="tf-divider">
            <span></span>
          </div>
          <div class="box box-coords" style="flex:1">
            <h5><b>Coordonnées chantier</b></h5>
            <p><span class="label pull-left mr-2">{{'CHANTIERS.CLIENT.SHORTTITLE' | translate}}</span><span class="">{{chantier.client}}</span></p>
            <p><span class="label pull-left mr-2">{{'CHANTIERS.ADRESS.SHORTTITLE' | translate}}</span><span class="">{{chantier.adresse}}</span></p>
            <p><span class="label pull-left mr-2">{{'COMMON.CITY.SHORTTITLE' | translate}}</span><span class="">{{chantier.ville}}</span></p>
            <p><span class="label pull-left mr-2">{{'COMMON.POSTCODE.SHORTTITLE' | translate}}</span><span class="">{{chantier.code_postal}}</span></p>
            <p><span class="label pull-left mr-2">{{'COMMON.COUNTRY.SHORTTITLE' | translate}}</span><span class="">{{chantier.pays}}</span></p>
          </div>
          <div class="tf-divider">
            <span></span>
          </div>
          <div class="box text-center">
            <small>{{'COMMON.CREATED_AT.TITLE' | translate}} : {{chantier.created_at | date:'dd/MM/yyyy'}}</small><br>
            <small>{{'COMMON.UPDATED_AT.TITLE' | translate}} : {{chantier.updated_at | date:'dd/MM/yyyy'}}</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card" >
          <h3>Informations sécurité</h3>
          <div *ngIf="chantier.latest_ar; else noAr">
              <div class="box" style="flex: 1;">
                <p><span class="label pull-left">{{'ARS.PREVOIR_COMPAGNONS.TITLE' | translate}}</span><br>{{chantier.latest_ar?.a_prevoir_compagnons ? 'Oui':'Non'}}</p>
                <p *ngIf="chantier.latest_ar?.a_prevoir_compagnons"><span class="label pull-left">{{'ARS.REALISATEUR.TITLE' | translate}}</span><br>{{chantier.latest_ar?.realisateur}}</p>
                <p *ngIf="chantier.latest_ar?.a_prevoir_compagnons"><span class="label pull-left">{{'ARS.DATE_ACCUEIL_SECU.TITLE' | translate}}</span><br>{{chantier.latest_ar?.date_accueil_secu | date:'dd/MM/yyyy'}}</p>
                <p *ngIf="chantier.latest_ar?.a_prevoir_compagnons"><span class="label pull-left">{{'ARS.DATE_VALIDITE.TITLE' | translate}}</span><br>{{chantier.latest_ar?.date_validite | date:'dd/MM/yyyy'}}</p>
                <div class="row" *ngIf="chantier.latest_ar?.a_prevoir_compagnons">
                  <div class="col-12 ">
                    <span class="label pull-left">{{'ARS.AS_DAYS.LABEL' | translate}}</span><br>
                  </div>
                  <div class="col-12 my-3">
                    <mat-chip-list *ngIf="chantier.latest_ar.accueil_secu_days; else noSecuDays">
                      <mat-chip *ngFor="let as_day of chantier.latest_ar.accueil_secu_days" class="chip-item">
                        {{as_day}}
                      </mat-chip>
                    </mat-chip-list>
                  </div>
                </div>
                <p><span class="label pull-left">{{'ARS.FORM.MWBLOCK.WORKREGISTER.TITLE' | translate}}</span><br>{{chantier.latest_ar?.a_signer_registre_travaux ? 'Oui':'Non'}}</p>
                <p *ngIf="chantier.latest_ar?.a_signer_registre_travaux"><span class="label pull-left">{{'ARS.ASIGNER.LABEL' | translate}}</span><br>{{chantier.latest_ar?.registre_signing_period}}</p>
              </div>
              <div class="box" style="flex: 1;">
                <h5><b>En cas d'urgence</b></h5>
                <p><span class="label pull-left mr-2">{{'ARS.CONTACT_INTERNE_SECOURS.SHORTTITLE' | translate}}</span><br><span class="blue">{{chantier.latest_ar?.contact_interne_secours}}</span></p>
                <p><span class="label pull-left mr-2">{{'ARS.TEL_CONTACT_INTERNE_SECOURS.SHORTTITLE' | translate}}</span><br><span class="blue">{{chantier.latest_ar?.tel_contact_interne_secours}}</span></p>
                <p class="mt-3"><span class="label pull-left mr-2">{{'ARS.CONTACT_CLIENT_HSE.SHORTTITLE' | translate}}</span><br><span class="blue">{{chantier.latest_ar?.contact_client_hse}}</span></p>
                <p><span class="label pull-left mr-2">{{'ARS.TEL_CONTACT_CLIENT_HSE.SHORTTITLE' | translate}}</span><br><span class="blue">{{chantier.latest_ar?.tel_contact_client_hse}}</span></p>
              </div>
          </div>
          <ng-template #noAr>
            <div class="box">
              Aucune analyse de risque pour le moment
            </div>
          </ng-template>
        </div>
      </div>
      <div class="col-md-5">
        <div class="card">
          <h3>Suivi de chantier</h3>
          <div class="box box-ar-vs" style="flex: 1;">
            <h5><b>Suivis analyses de risques</b><small class="pull-right">{{'CHANTIERS.ARCOUNT.SHORTTITLE' | translate}} : <span class="blue">{{chantier.ars.length}}</span></small></h5>
            <div class="row">
              <div class="col-md-6"><p><span class="label pull-left mr-2">{{'CHANTIERS.NEXTAR.TITLE' | translate}}</span></p></div>
              <div class="col-md-6"><p  class="text-right blue">{{chantier.latest_ar?.date_validite | date:'dd/MM/yyyy'}}</p></div>
            </div>
            <div class="row">
              <div class="col-md-6"><p><span class="label pull-left mr-2">{{'CHANTIERS.ARS.TITLE' | translate}}</span></p></div>
              <div class="col-md-6"><p class="text-right" *ngFor="let ar of chantier.ars">{{ar.date | date:'dd/MM/yyyy'}}</p></div>
            </div>
          </div>
          <div class="box box-ar-vs" style="flex: 1;">
            <h5><b>Suivis visites de sécurité</b><small class="pull-right">{{'CHANTIERS.VSCOUNT.SHORTTITLE' | translate}} : <span class="blue">{{chantier.vss.length}}</span></small></h5>
            <div class="row">
              <div class="col-md-6"><p><span class="label pull-left mr-2">{{'CHANTIERS.VSS.TITLE' | translate}}</span></p></div>
              <div class="col-md-6"><p class="text-right" *ngFor="let vs of chantier.vss">{{vs.date_visite | date:'dd/MM/yyyy'}}</p></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-12 mt-4">
        <div class="card" *ngIf="chantier.entreprises.length; else noEntreprises">
          <h5>{{'CHANTIERS.EES.TITLE' | translate}}<small class="pull-right">{{'CHANTIERS.EECOUNT.SHORTTITLE' | translate}} : <span class="blue">{{chantier.entreprises.length}}</span></small></h5>
          <div class="px-5">
            <table class="table table-borderless table-sm table-striped px-4">
              <thead>
                <tr>
                  <th scope="col">{{'EES.RAISON_SOCIALE.TITLE' | translate}}</th>
                  <th class="text-center" scope="col">{{'EES.TYPE.TITLE' | translate}}</th>
                  <th class="text-center" scope="col">{{'EES.CA.TITLE' | translate}}</th>
                  <th class="text-center" scope="col">{{'EES.DATE_DEMARRAGE.TITLE' | translate}}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entreprise of chantier.entreprises">
                  <th scope="row">{{entreprise.raison_sociale}}</th>
                  <td class="text-center">{{entreprise.type.libelle}}</td>
                  <td class="text-center">{{entreprise.pivot.chiffre_affaire | currency:'EUR':'€'}}</td>
                  <td class="text-center">{{entreprise.pivot.date_demarrage | date:'dd/MM/yyyy'}}</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-12 mt-4">
        <div class="card" *ngIf="!chantier.no_hab_required; else noHabRequired">
          <h5> Habilitations obligatoires pour accéder au chantier <small class="pull-right">{{'CHANTIERS.HABCOUNT.SHORTTITLE' | translate}} : <span class="blue">{{chantier.habilitations.length}}</span></small></h5>
          <ul>
            <li *ngFor="let hab of chantier.habilitations">
              {{hab.libelle}}
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row mt-4" *ngIf="chantier.status.code != 'TERMINE'">
      <div class="col-12">
        <button mat-raised-button color="info" (click)="closeChantier(chantier.id)">
          <mat-icon  svgIcon="status-termine" inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;"></mat-icon>
          Clore le chantier
        </button>
        <span class="pull-right" 
          matTooltip="Le montant du chantier est inférieur à 20K€, vous ne pouvez pas créer d\'analyse de risque" 
          [matTooltipDisabled]="this.chantier.montant > 20000">
          <button mat-raised-button color="info" (click)="addAr(chantier.id)" [disabled]="this.chantier.montant <= 20000">
            <mat-icon inline="true" style="width: 21px; margin-top: -6px; margin-right: 6px;">add</mat-icon>
            Créer Analyse de risque
          </button>
        </span>
      </div>
    </div>
  </tf-portlet-body>
</tf-portlet>

<ng-template #noEntreprises>
  <div class="card">
    <h5 class="mb-4">Aucune Entreprise Externe</h5>
  </div>
</ng-template>

<ng-template #noHabRequired>
  <div class="card">
    <h5 class="mb-4">Aucune habilitations obligatoires pour accéder au chantier</h5>
  </div>
</ng-template>
<ng-template #noSecuDays>
  -
</ng-template>